<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pandemia</title>
<meta name="author" content="Allan Jales https://github.com/allanjales/">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<style>
body{
	margin: 0;
	overflow: hidden;
}
#canvas{
	background-color: #EEEEEE;
}
.custom-control-label::after{
	cursor: pointer;
}
</style>

</head>

<body>
	<main class="m-auto" style="width: 1280px">
		<canvas id="canvas" width="1280" height="720"></canvas>
		<div class="p-3">
			<div class="form-row">
				<div class="form-group col-4">
					<div class="custom-control custom-checkbox">
						<input id="avoidHealthier" class="custom-control-input synchronous" type="checkbox">
						<label for="avoidHealthier" class="custom-control-label">Population avoid healthier</label>
					</div>
					<div class="custom-control custom-checkbox">
						<input id="avoidInfected" class="custom-control-input synchronous" type="checkbox" checked>
						<label for="avoidInfected" class="custom-control-label">Population avoid infected</label>
					</div>
					<div class="custom-control custom-checkbox">
						<input id="avoidSymptomatic" class="custom-control-input synchronous" type="checkbox" checked>
						<label for="avoidSymptomatic" class="custom-control-label">Population avoid symptomatic</label>
					</div>
					<div class="custom-control custom-checkbox">
						<input id="avoidDead" class="custom-control-input synchronous" type="checkbox">
						<label for="avoidDead" class="custom-control-label">Population avoid dead</label>
					</div>
				</div>
				<div class="form-group col-4">
					<div class="custom-control custom-checkbox">
						<input id="deathTransmission" class="custom-control-input synchronous" type="checkbox">
						<label for="deathTransmission" class="custom-control-label">Transmission after death</label>
					</div>
				</div>
				<div class="form-group col-4">
					<div class="custom-control custom-checkbox">
						<input id="showInfectionRadius" class="custom-control-input synchronous" type="checkbox">
						<label for="showInfectionRadius" class="custom-control-label">Show infection radius</label>
					</div>
					<div class="custom-control custom-checkbox">
						<input id="showSafeDistance" class="custom-control-input synchronous" type="checkbox">
						<label for="showSafeDistance" class="custom-control-label">Show known safe distance</label>
					</div>
					<div class="custom-control custom-checkbox">
						<input id="showDirection" class="custom-control-input synchronous" type="checkbox">
						<label for="showDirection" class="custom-control-label">Show direction</label>
					</div>
				</div>
				<button type="button" class="btn btn-light" onclick="game.gameSpeed > 0 ? game.setGameSpeed(0) : game.setGameSpeed(60)">Start/Pause</button>
				<button type="button" class="btn btn-light ml-2" onclick="game.disease.infectRandom()">Infect random</button>
			</div>
		</div>
	</main>
</body>
</html>

<script type="text/javascript">
	//Parameters
	const cobaiasRadius = 10;

	//Get canvas
	const canvas = document.getElementById("canvas");
	const ctx = canvas.getContext("2d");

	//After page load
	window.onload = function()
	{
		game.createCobaias(100);
		game.setGameSpeed(60);
		input.prepare();
	}

	//Input dealer
	const input = {
		prepare: function()
		{
			let inputs = document.getElementsByClassName('synchronous');

			for (const input of inputs)
			{
				input.addEventListener('change', (event) => {this[event.target.id](event.target);});
			}

			input.update();
		},
		update: function()
		{
			let inputs = document.getElementsByClassName('synchronous');

			for (const input of inputs)
			{
				this[input.id](input);
			}
		},
		avoidHealthier: function(object)
		{
			game.disease.prevention.avoidHealthier = object.checked;
		},
		avoidInfected: function(object)
		{
			game.disease.prevention.avoidInfected = object.checked;
		},
		avoidSymptomatic: function(object)
		{
			game.disease.prevention.avoidSymptomatic = object.checked;
		},
		avoidDead: function(object)
		{
			game.disease.prevention.avoidDead = object.checked;
		},
		deathTransmission: function(object)
		{
			game.disease.deathTransmission = object.checked;
		},
		showInfectionRadius: function(object)
		{
			game.showInfectionRadius = object.checked;
		},
		showSafeDistance: function(object)
		{
			game.showSafeDistance = object.checked;
		},
		showDirection: function(object)
		{
			game.showDirection = object.checked;
		}
	}

	const game = {
		gameSpeed: 0,
		cobaias: [],
		disease: {},
		color: {},
		showDirection: false,
		showInfectionRadius: false,
		showSafeDistance: false,
		setGameSpeed: function(newSpeed)
		{
			//Change the variable
			this.gameSpeed = (newSpeed > 0) ? newSpeed : 0;
			
			//Reset previus interval
			clearInterval(this.stepInterval);
			
			//Change the interval
			if (this.gameSpeed > 0)
				this.stepInterval = setInterval(step, 1000/this.gameSpeed);
				
			return this.gameSpeed;
		},
		createCobaias: function (number)
		{
			for (let i = 0; i < number; i++)
			{
				//Create cobaias
				this.cobaias.push({
					id: i,
					x: Math.round(Math.random()*(canvas.width - cobaiasRadius*2)),
					y: Math.round(Math.random()*(canvas.height - cobaiasRadius*2)),
					radius: 10,
					direction: 		null,
					isInfected: 	false,
					isSymptomatic: 	false,
					isDead: 		false,
					walkDistance: 	4,
					walkDeviation: 	Math.PI/4,
					safeDistance: 	25,
					walkRandom: function()
					{
						let direction;

						//Choose new direction
						if (this.direction == null)
						{
							direction = Math.random()*2*Math.PI;
						}
						else
						{
							direction = this.direction + Math.random()*this.walkDeviation - this.walkDeviation/2;
						}

						//Change directions if outside
						if (this.x >= canvas.width - cobaiasRadius)
						{
							direction = Math.random()*Math.PI + Math.PI/2;
						}
						if (this.x <= cobaiasRadius)
						{
							direction = Math.random()*Math.PI - Math.PI/2;
						}
						if (this.y >= canvas.height - cobaiasRadius)
						{
							direction = Math.random()*Math.PI + Math.PI;
						}
						if (this.y <= cobaiasRadius)
						{
							direction = Math.random()*Math.PI;
						}

						//Estimates new position
						let deltaX = Math.cos(direction)*this.walkDistance;
						let deltaY = Math.sin(direction)*this.walkDistance;
						
						//Change cobaia proprieties
						this.direction = direction;
						this.x += deltaX;
						this.y += deltaY;
					},
					walkAway: function()
					{
						//List
						let near;

						//List everyone to get away
						for (const cobaia of game.cobaias)
						{
							if (cobaia.id != this.id && game.get.distance(this, cobaia) <= this.safeDistance
								&& (
										(game.disease.prevention.avoidHealthier 		&& (!cobaia.isInfected || !cobaia.isSymptomatic))
										|| (game.disease.prevention.avoidInfected 		&& cobaia.isInfected)
										|| (game.disease.prevention.avoidSymptomatic 	&& cobaia.isSymptomatic)
										|| (game.disease.prevention.avoidDead			&& cobaia.isDead)
									)
								)
							{
								if (!near || game.get.distance(this, cobaia) < game.get.distance(this, near))
								{
									near = cobaia;
								}
							}
						}

						//Walk on direction
						if (near)
						{
							let direction = game.get.angle(this, near) + Math.PI;

							//Change directions if outside
							if (this.x >= canvas.width - cobaiasRadius)
							{
								direction = Math.random()*Math.PI + Math.PI/2;
							}
							if (this.x <= cobaiasRadius)
							{
								direction = Math.random()*Math.PI - Math.PI/2;
							}
							if (this.y >= canvas.height - cobaiasRadius)
							{
								direction = Math.random()*Math.PI + Math.PI;
							}
							if (this.y <= cobaiasRadius)
							{
								direction = Math.random()*Math.PI;
							}

							//Estimates new position
							let deltaX = Math.cos(direction)*this.walkDistance;
							let deltaY = Math.sin(direction)*this.walkDistance;
							
							//Change cobaia proprieties
							this.direction = direction;
							this.x += deltaX;
							this.y += deltaY;
						}
						else
						{
							this.walkRandom();
						}
					},
					walk: function()
					{
						if (game.disease.prevention.avoidHealthier || game.disease.prevention.avoidInfected || game.disease.prevention.avoidSymptomatic)
							this.walkAway();
						else
							this.walkRandom();
					},
					infect: function()
					{
						this.isInfected = date.get();
					},
					symptoms: function()
					{
						this.isSymptomatic = true;
					},
					kill: function()
					{
						this.isDead = true;
					},
					checkLifeTime: function()
					{
						if (this.isInfected)
						{
							let difference = date.difference(this.isInfected);

							//If should be killed
							if (difference >= game.disease.lifeTime)
							{
								this.kill();
							}

							//If should show symptoms
							if (difference >= game.disease.symptomaticTime)
							{
								this.symptoms();
							}

							return difference;
						}
					}
				})
			}
		},
		get: {
			distance: function (cobaia1, cobaia2)
			{
				let distance = Math.sqrt(Math.pow((cobaia1.x - cobaia2.x),2) + Math.pow((cobaia1.y - cobaia2.y),2));

				return distance;
			},
			angle: function(cobaia1, cobaia2)
			{
				let angle = Math.atan((cobaia2.y - cobaia1.y)/(cobaia2.x - cobaia1.x));

				//Corrects angle
				if (cobaia1.x >= cobaia2.x)
				{
					angle += Math.PI;
				}

				return angle;
			},
			point: function(x, y, distance, angle)
			{
				let point = {
					x: x + Math.cos(angle)*distance,
					y: y + Math.sin(angle)*distance
				}

				return point;
			}
		},
		count: function()
		{
			let count = {
						health: 0,
						infected: 0,
						dead: 0
						}

			for (cobaia of game.cobaias)
			{
				if (cobaia.isDead)
				{
					count.dead++;
					continue;
				}
				if (cobaia.isInfected)
				{
					count.infected++;
					continue;
				}
				if (!cobaia.isInfected)
				{
					count.health++;
					continue;
				}
			}

			return count;
		},
		percent: function()
		{
			let count = this.count();
			let total = count.health + count.infected + count.dead;

			let percent = {
						health: count.health/total*100,
						infected: count.infected/total*100,
						dead: count.dead/total*100
						}

			return percent;
		}
	}

	game.color = {
		normal: 		"#0000AA",
		infected: 		"#AA6600",
		symptomatic: 	"#AA0000",
		dead: 			"#AAAAAA",
		direction: 		"#888888",
		safeDistance: 	"#00AA00"
		}

	//Disease information
	game.disease = {
		infectionRadius: 25,
		infectionRate: 0.02,
		symptomaticTime: 10000,
		lifeTime: 20000,
		deathTransmission: false,
		prevention: {
			avoidHealthier: 	true,
			avoidInfected: 		true,
			avoidSymptomatic: 	true,
			avoidDead: 			true
		},
		infectRandom: function()
		{
			//List
			let uninfected = [];

			//List every uninfected
			for (const cobaia of game.cobaias)
			{
				if (!cobaia.isInfected)
				{
					uninfected.push(cobaia.id);
				}
			}

			//Get random key
			let key = Math.round(Math.random()*(uninfected.length-1));

			//Pick key from array
			let picked = uninfected[key];

			//If got a cobaia, infect
			if (picked || picked === 0)
			{
				game.cobaias[picked].infect();
				return picked;
			}

			return false;
		}
	}

	const date = {
		get: function(){
			let now = new Date();
			return now;
		},
		difference: function(before){
			let now = new Date();
			return now - before;
		}
	}

	function step()
	{
		//Change cobaias position
		for (const cobaia of game.cobaias)
		{
			if (!cobaia.isDead)
			{
				cobaia.walk();
			}
		}

		//Kill cobaias
		for (const cobaia of game.cobaias)
		{
			if (!cobaia.isDead)
			{
				cobaia.checkLifeTime();
			}
		}

		//Infection
		for (const cobaia of game.cobaias)
		{
			//If is not infected
			if (cobaia.isInfected == false)
			{
				//Check distance to others
				for (const otherCobaia of game.cobaias)
				{
					//If a infected is near
					if (otherCobaia.isInfected && game.get.distance(cobaia, otherCobaia) <= game.disease.infectionRadius && (game.disease.deathTransmission || !otherCobaia.isDead))
					{
						//Should it be infected?
						if (Math.random() <= game.disease.infectionRate)
						{
							cobaia.infect();
						}
					}
				}
			}
		}
	}
	
	renderScreen();

	//Draw in canvas
	function renderScreen()
	{
		//Clear canvas
		ctx.clearRect(0, 0, canvas.width, canvas.height);

		//Draw cobaias
		for (const cobaia of game.cobaias)
		{
			//Draw body
			ctx.beginPath();
			ctx.arc(cobaia.x, cobaia.y, cobaiasRadius, 0, 2*Math.PI);
			ctx.fillStyle =  game.color.normal;
			if (cobaia.isInfected)
				ctx.fillStyle = game.color.infected;
			if (cobaia.isSymptomatic)
				ctx.fillStyle = game.color.symptomatic;
			if (cobaia.isDead)
				ctx.fillStyle = game.color.dead;
			ctx.fill();

			//Draw safe distance
			if (game.showSafeDistance && cobaia.isDead == false)
			{
				ctx.beginPath();
				ctx.arc(cobaia.x, cobaia.y, cobaia.safeDistance, 0, 2*Math.PI);
				ctx.strokeStyle = game.color.safeDistance;
				ctx.stroke();
			}

			//Draw infection radius
			if (game.showInfectionRadius && cobaia.isInfected && (cobaia.isDead == false || game.disease.deathTransmission))
			{
				ctx.beginPath();
				ctx.arc(cobaia.x, cobaia.y, game.disease.infectionRadius, 0, 2*Math.PI);
				ctx.strokeStyle = game.color.infected;
				if (cobaia.isSymptomatic)
					ctx.strokeStyle = game.color.symptomatic;
				if (cobaia.isDead)
					ctx.strokeStyle = game.color.dead;
				ctx.stroke();
			}

			//Draw walk direction
			if (game.showDirection && cobaia.isDead == false)
			{
				ctx.beginPath();
				ctx.arc(cobaia.x, cobaia.y, cobaia.safeDistance, cobaia.direction-cobaia.walkDeviation/2, cobaia.direction+cobaia.walkDeviation/2);
				ctx.strokeStyle = game.color.direction;
				ctx.stroke();

				let points = {
					1: game.get.point(cobaia.x, cobaia.y, cobaia.safeDistance, cobaia.direction-cobaia.walkDeviation/2),
					2: game.get.point(cobaia.x, cobaia.y, cobaia.safeDistance, cobaia.direction+cobaia.walkDeviation/2)
				}

				ctx.beginPath();
				ctx.moveTo(cobaia.x, cobaia.y);
				ctx.lineTo(points[1].x, points[1].y);
				ctx.strokeStyle = game.color.direction;
				ctx.stroke();

				ctx.beginPath();
				ctx.moveTo(cobaia.x, cobaia.y);
				ctx.lineTo(points[2].x, points[2].y);
				ctx.strokeStyle = game.color.direction;
				ctx.stroke();
			}
		}

		//Recursive
		requestAnimationFrame(renderScreen);
	}
</script>